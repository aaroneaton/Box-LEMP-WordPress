name: box-lemp-wordpress
version: 0.0.1
inherits: wercker/php@1.0.2
type: service
platform: ubuntu@12.04
description: Wercker box for LEMP and WordPress
keywords:
  - lemp
  - wordpress
packages:
  - mysql-server
script: |
  sudo su root
  apt-get update -y
  apt-get install nginx -y
  pwd
  ls -la

  # Nginx setup
  cp -f config/nginx/nginx.conf /etc/nginx/nginx.conf
  cp -f config/nginx/nginx-wp-common.conf /etc/nginx/nginx-wp-common.conf
  cp -f config/nginx/sites/default.conf /etc/nginx/sites-enabled/default.conf
  cd /etc/nginx
  chmod 644 nginx.conf nginx-wp-common.conf sites-enabled/default.conf
  ls -la /etc/nginx
  service nginx restart
  whoami

  # Install wp-cli
  git clone git://github.com/wp-cli/wp-cli.git /srv/www/wp-cli
  cd /srv/www/wp-cli
  composer install
  ln -sf /srv/www/wp-cli/bin/wp /usr/local/bin/wp

  # Create server user
  useradd www-data
  groupadd www-data

  # Install WordPress
  mkdir /srv/www/wordpress
  cd /srv/www/wordpress
  chown -R www-data /srv/www
  chgrp -R www-data /srv/www
  # Add www-data user and group
  # Maybe look at using new-site script on roark
  wp core download
  wp core config --dbname=WERCKER_MYSQL_DATABASE --dbuser=WERCKER_MYSQL_USERNAME --dbpass=WERCKER_MYSQL_PASSWORD --extra-php <<PHP
  define( 'WP_DEBUG', true);
  PHP
  wp core install --url="local.wordpress.dev" --title="Wercker Test" --admin_user="admin" --admin_password="password" --admin_email="test@test.com"
  wp core version

  # Fix up the permissions
  chown -R www-data .
  chgrp -R www-data .
  find . -type d -exec chmod 775 {} \;
  find . -type f -exec chmod 664 {} \;

  service nginx restart
  exit
  whoami
